from collections import defaultdict

from app.universe import load_universe, attach_market_cap
from app.scanner import intraday_bb_rebound, intraday_bb_touch
from app.favorites import FAVORITES
from app.state import should_alert, mark_alerted
from app.formatter import format_sector_message, format_favorites
from app.telegram import send_message


TOP_PER_SECTOR = 10

def run():
    symbols = load_universe()
    df = attach_market_cap(symbols)  # symbol, sector, market_cap...

    sector_hits = defaultdict(list)   # sector -> [(symbol, market_cap)]
    favorite_hits = []

    for row in df.itertuples():
        symbol = row.symbol

        if not should_alert(symbol):
            continue

        # â­ ì¦ê²¨ì°¾ê¸°: BB í•˜ë‹¨ í„°ì¹˜ë§Œ
        if symbol in FAVORITES:
            if intraday_bb_touch(symbol):
                favorite_hits.append(symbol)
                mark_alerted(symbol)
            continue

        # ğŸ“Œ ì¼ë°˜: BB í•˜ë‹¨ í„°ì¹˜ + ë°˜ë“± + ê±°ë˜ëŸ‰(ìŠ¤ìºë„ˆ ë‚´ë¶€)
        if intraday_bb_rebound(symbol):
            sector_hits[row.sector].append((symbol, row.market_cap))
            mark_alerted(symbol)

    # âœ… ì„¹í„°ë³„ "ì‹œì´ ë‚´ë¦¼ì°¨ìˆœ" Top10 ì„ ì •
    for sector, items in sector_hits.items():
        items.sort(key=lambda x: x[1] or 0, reverse=True)
        top_symbols = [s for s, _ in items[:TOP_PER_SECTOR]]
        send_message(format_sector_message(sector, top_symbols, top_n=TOP_PER_SECTOR))

    fav_msg = format_favorites(favorite_hits)
    if fav_msg:
        send_message(fav_msg)
